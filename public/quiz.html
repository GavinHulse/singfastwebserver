<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz App - Question</title>
    <link rel="stylesheet" href="style.css">
</head>
        
<body>
    <div class="container">
        <div class="quiz-container">
            <div class="user-info">
                <span id="userDisplay"></span>
            </div>
            
            <h1>Think Fast!</h1>
            <div class="questionContent" id="questionContent">
                <div id="questionNumber">Loading...</div>
                <div id="messages">Loading question...</div>
            </div>
            
            <div class="cooldown" id="cooldown">
                <div class="answer-section">
                    <div class="answer-buttons">
                        <button id="btn0">A</button>
                        <button id="btn1">B</button>
                        <button id="btn2">C</button>
                        <button id="btn3">D</button>
                    </div>
                </div>
            </div>
            
            <div id="waitingMessage" class="waiting-message" style="display: none;">
                <h2>Waiting for next question...</h2>
                <p id="statusText">Please wait</p>
            </div>
            
            <div id="endScreen" class="end-screen" style="display: none;">
                <h2>ðŸŽ‰ Game Over! ðŸŽ‰</h2>
                <p id="endMessage">Thanks for playing!</p>
                <div class="final-score" id="finalScore">
                    Your Final Score: <span id="scoreValue">0</span>
                </div>
                <p>Great job! Hope you had fun!</p>
            </div>
            
            <label id="submitted_label"></label>
            
            <!-- Developer Controls 
            <div class="developer-controls" style="display: none;">
                <h3>Developer Controls</h3>
                <div class="dev-buttons">
                    <button id="clearRoomBtn" class="dev-btn danger">Clear Room Data</button>
                    <button id="nextQuestionBtn" class="dev-btn">Next Question</button>
                    <button id="resetScoresBtn" class="dev-btn danger">Reset All Scores</button>
                </div>
            </div> -->
            
            <div id="message" class="message"></div>
        </div>
    </div>

    <script>
        // Global variables
        let currentQuestionId = null;
        let hasAnswered = false;
        let selectedAnswer = null;
        let eventSource = null;
        let currentPlayerScore = 0;
        let isInitialized = false;
        
        console.log('Quiz page loaded, starting initialization...');
        
        // Check if user is registered
        const username = sessionStorage.getItem('username');
        const roomCode = sessionStorage.getItem('roomCode');
        
        if (!username || !roomCode) {
            console.log('No username or room code found, redirecting to home');
            window.location.href = '/';
            // Stop execution if redirecting
            throw new Error('Redirecting to home page');
        }
        
        console.log(`User: ${username}, Room: ${roomCode}`);
        document.getElementById('userDisplay').textContent = `${username} (Room: ${roomCode})`;
        
        // Initialize SSE connection
        function initializeSSE() {
            console.log('Initializing SSE connection...');
            
            if (eventSource) {
                eventSource.close();
            }
            
            eventSource = new EventSource('/events');
            
            eventSource.onopen = function(event) {
                console.log('SSE connection opened');
            };
            
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('Received SSE data:', data);
                
                if (data.type === 'question') {
                    updateUI(data);
                } else if (data.type === 'gameReset') {
                    handleGameReset();
                } else if (data.type === 'gameEnd') {
                    handleGameEnd('Game completed! You\'ve answered all questions.');
                } else if (data.type === 'scoreReset') {
                    handleGameEnd('All scores have been reset!');
                }
            };
            
            eventSource.onerror = function(error) {
                console.error('SSE connection error:', error);
                console.log('SSE readyState:', eventSource.readyState);
                
                // Attempt to reconnect after 3 seconds
                setTimeout(() => {
                    if (eventSource.readyState === EventSource.CLOSED) {
                        console.log('Attempting to reconnect SSE...');
                        initializeSSE();
                    }
                }, 3000);
            };
        }
        
        // Load initial question on page load
        async function loadInitialQuestion() {
            console.log('Loading initial question...');
            try {
                const response = await fetch('/api/question');
                const data = await response.json();
                console.log('Initial question data:', data);
                
                if (data.isGameEnded) {
                    handleGameEnd('Game has ended');
                } else if (data.question) {
                    updateUI(data);
                } else {
                    console.log('No active question, showing waiting screen');
                    showWaitingScreen();
                }
            } catch (error) {
                console.error('Error loading initial question:', error);
                showErrorState('Failed to load question. Please refresh the page.');
            }
        }
        
        // Show waiting screen
        function showWaitingScreen() {
            console.log('Showing waiting screen');
            document.getElementById('questionContent').style.display = 'none';
            document.getElementById('waitingMessage').style.display = 'block';
            document.getElementById('endScreen').style.display = 'none';
            document.getElementById('statusText').textContent = 'Waiting for next question...';
        }
        
        // Show error state
        function showErrorState(message) {
            console.log('Showing error state:', message);
            document.getElementById('questionNumber').textContent = 'Error';
            document.getElementById('messages').textContent = message;
            document.getElementById('questionContent').style.display = 'block';
            document.getElementById('waitingMessage').style.display = 'none';
            document.getElementById('endScreen').style.display = 'none';
            
            // Disable all buttons
            for (let i = 0; i < 4; i++) {
                const btn = document.getElementById(`btn${i}`);
                if (btn) {
                    btn.disabled = true;
                }
            }
        }
        
        // Load current player score
        async function loadPlayerScore() {
            console.log('Loading player score...');
            try {
                const response = await fetch(`/api/player-score/${roomCode}/${username}`);
                const data = await response.json();
                if (data.score !== undefined) {
                    currentPlayerScore = data.score;
                    console.log('Current player score:', currentPlayerScore);
                }
            } catch (error) {
                console.error('Error loading player score:', error);
                // Don't fail initialization if score loading fails
            }
        }
        
        function updateUI(data) {
            console.log('Updating UI with data:', data);
            const questionContent = document.getElementById('questionContent');
            const waitingMessage = document.getElementById('waitingMessage');
            const endScreen = document.getElementById('endScreen');
            const statusText = document.getElementById('statusText');
            
            // Hide end screen when showing questions
            endScreen.style.display = 'none';
            
            if (data.isActive && data.question) {
                console.log('Showing active question');
                // Show question
                waitingMessage.style.display = 'none';
                questionContent.style.display = 'block';
                
                // Update question display
                document.getElementById('questionNumber').textContent = `Q ${data.questionIndex + 1}/12`;
                document.getElementById('messages').textContent = data.question.question;
                
                // Update answer buttons with options
                if (data.question.options && data.question.options.length >= 4) {
                    data.question.options.forEach((option, index) => {
                        const btn = document.getElementById(`btn${index}`);
                        if (btn) {
                            btn.textContent = `${option}`;
                            btn.disabled = false;
                            btn.classList.remove('selected', 'submitted');
                        }
                    });
                } else {
                    console.error('Question options are missing or incomplete');
                    // Show generic buttons
                    for (let i = 0; i < 4; i++) {
                        const btn = document.getElementById(`btn${i}`);
                        if (btn) {
                            btn.textContent = String.fromCharCode(65 + i);
                            btn.disabled = true;
                        }
                    }
                }
                
                // Reset answer state for new question
                if (currentQuestionId !== data.question.id) {
                    console.log('New question detected, resetting answer state');
                    currentQuestionId = data.question.id;
                    hasAnswered = false;
                    selectedAnswer = null;
                    document.getElementById('submitted_label').textContent = '';
                }
            } else {
                console.log('No active question, showing waiting screen');
                // No active question - show waiting screen
                showWaitingScreen();
                currentQuestionId = null;
                hasAnswered = false;
            }
        }
        
        function handleGameEnd(message) {
            console.log('Handling game end:', message);
            // Hide other screens
            document.getElementById('questionContent').style.display = 'none';
            document.getElementById('waitingMessage').style.display = 'none';
            
            // Show end screen
            const endScreen = document.getElementById('endScreen');
            const endMessage = document.getElementById('endMessage');
            const scoreValue = document.getElementById('scoreValue');
            
            endMessage.textContent = message;
            scoreValue.textContent = currentPlayerScore;
            endScreen.style.display = 'block';
            
            // Reset game state
            currentQuestionId = null;
            hasAnswered = false;
            selectedAnswer = null;
            document.getElementById('submitted_label').textContent = '';
            
            // Reset buttons
            for (let i = 0; i < 4; i++) {
                const btn = document.getElementById(`btn${i}`);
                if (btn) {
                    btn.textContent = String.fromCharCode(65 + i);
                    btn.disabled = true;
                    btn.classList.remove('selected', 'submitted');
                }
            }
        }
        
        function handleGameReset() {
            console.log('Handling game reset');
            // Reset all UI elements
            document.getElementById('questionNumber').textContent = 'Loading...';
            document.getElementById('messages').textContent = 'Loading question...';
            document.getElementById('submitted_label').textContent = '';
            
            // Hide end screen
            document.getElementById('endScreen').style.display = 'none';
            
            // Reset buttons
            for (let i = 0; i < 4; i++) {
                const btn = document.getElementById(`btn${i}`);
                if (btn) {
                    btn.textContent = String.fromCharCode(65 + i);
                    btn.disabled = true;
                    btn.classList.remove('selected', 'submitted');
                }
            }
            
            // Show waiting message
            showWaitingScreen();
            document.getElementById('statusText').textContent = 'Game has been reset. Waiting for new questions...';
            
            // Reset game state
            currentQuestionId = null;
            hasAnswered = false;
            selectedAnswer = null;
        }
        
        // Answer submission function
        async function submitAnswer(answerIndex) {
            if (hasAnswered) {
                console.log('Answer already submitted for this question');
                return;
            }
            
            console.log('Submitting answer:', answerIndex);
            const answerLetter = String.fromCharCode(97 + answerIndex); // 'a', 'b', 'c', 'd'
            const messageDiv = document.getElementById('message');
            
            try {
                const response = await fetch('/api/submit-answer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, roomCode, answer: answerLetter })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    hasAnswered = true;
                    selectedAnswer = answerIndex;
                    currentPlayerScore = data.currentScore || currentPlayerScore;
                    
                    // Update UI to show answer was submitted
                    document.getElementById('submitted_label').textContent = 'Answer Submitted!';
                    document.getElementById(`btn${answerIndex}`).classList.add('submitted');
                    
                    // Disable all buttons
                    for (let i = 0; i < 4; i++) {
                        document.getElementById(`btn${i}`).disabled = true;
                    }
                    
                    messageDiv.textContent = 'Answer submitted successfully!';
                    messageDiv.className = 'message success';
                    
                    console.log('Answer submitted successfully, new score:', currentPlayerScore);
                } else {
                    messageDiv.textContent = data.error || 'Submission failed';
                    messageDiv.className = 'message error';
                    console.error('Answer submission failed:', data.error);
                }
            } catch (error) {
                messageDiv.textContent = 'Network error. Please try again.';
                messageDiv.className = 'message error';
                console.error('Network error during answer submission:', error);
            }
        }
        
        // Add event listeners for answer buttons
        for (let i = 0; i < 4; i++) {
            const btn = document.getElementById(`btn${i}`);
            if (btn) {
                btn.addEventListener('click', () => {
                    submitAnswer(i);
                });
            }
        }
        
        // Developer Controls (only add listeners if elements exist)
        const nextQuestionBtn = document.getElementById('nextQuestionBtn');
        if (nextQuestionBtn) {
            nextQuestionBtn.addEventListener('click', async () => {
                try {
                    const response = await fetch('/api/next-question', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    const data = await response.json();
                    console.log('Next question triggered:', data);
                } catch (error) {
                    console.error('Error triggering next question:', error);
                }
            });
        }
        
        const clearRoomBtn = document.getElementById('clearRoomBtn');
        if (clearRoomBtn) {
            clearRoomBtn.addEventListener('click', async () => {
                const confirmClear = confirm(`Are you sure you want to clear ALL data for room "${roomCode}"? This action cannot be undone.`);
                
                if (confirmClear) {
                    try {
                        const response = await fetch('/api/clear-room', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ roomCode })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            alert('Room data cleared successfully!');
                        } else {
                            alert('Failed to clear room data: ' + data.error);
                        }
                    } catch (error) {
                        alert('Network error while clearing room data');
                    }
                }
            });
        }
        
        const resetScoresBtn = document.getElementById('resetScoresBtn');
        if (resetScoresBtn) {
            resetScoresBtn.addEventListener('click', async () => {
                const confirmReset = confirm('Are you sure you want to reset ALL player scores? This action cannot be undone.');
                
                if (confirmReset) {
                    try {
                        const response = await fetch('/api/reset-scores', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            }
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            alert('All player scores reset successfully!');
                            currentPlayerScore = 0;
                        } else {
                            alert('Failed to reset scores: ' + data.message);
                        }
                    } catch (error) {
                        alert('Network error while resetting scores');
                    }
                }
            });
        }
        
        // Initialize everything when page loads
        async function initializeApp() {
            console.log('Initializing app...');
            
            if (isInitialized) {
                console.log('App already initialized');
                return;
            }
            
            try {
                // Load player score first
                await loadPlayerScore();
                
                // Initialize SSE connection
                initializeSSE();
                
                // Load initial question after a small delay to ensure SSE is connected
                setTimeout(async () => {
                    await loadInitialQuestion();
                    isInitialized = true;
                    console.log('App initialization complete');
                }, 500);
                
            } catch (error) {
                console.error('Error during app initialization:', error);
                showErrorState('Failed to initialize. Please refresh the page.');
            }
        }
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            // DOM is already ready
            initializeApp();
        }
        
        // Clean up SSE connection when page unloads
        window.addEventListener('beforeunload', function() {
            console.log('Page unloading, closing SSE connection');
            if (eventSource) {
                eventSource.close();
            }
        });
        
        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log('Page hidden');
            } else {
                console.log('Page visible, checking connection status');
                if (eventSource && eventSource.readyState === EventSource.CLOSED) {
                    console.log('SSE connection was closed, reinitializing...');
                    initializeSSE();
                }
            }
        });
    </script>
</body>
</html>